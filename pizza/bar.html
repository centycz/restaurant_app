<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar - Objedn√°vky</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .nav-link {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .nav-link.active { background: white; color: #f7971e; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .section-title { font-size: 1.6em; color: #f7971e; margin: 25px 0 10px 0; font-weight: bold; }
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 30px;}
        .order-card { border: 3px solid #ffd200; border-radius: 15px; padding: 20px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.07); transition: transform 0.3s ease;}
        .order-card.urgent { border-color: #f7971e; background: #fffbe3;}
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee;}
        .table-number { font-size: 1.3em; font-weight: bold; color: #f7971e; display: flex; align-items: center; gap: 10px;}
        .order-time { color: #666; font-size: 0.95em;}
        .priority-badge { background: #f7971e; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; margin-left: 8px;}
        .order-items { margin-bottom: 20px; }
        .order-item { background: #fffbe6; border-radius: 8px; border-left: 4px solid #f7971e; padding: 12px 15px; margin-bottom: 9px;}
        .item-name { font-weight: 600; color: #333; margin-bottom: 3px;}
        .item-quantity { color: #666; font-size: 0.93em; margin-bottom: 3px;}
        .item-note { background: #fffde7; border: 1px solid #fff9c4; border-radius: 6px; padding: 6px 10px; margin-top: 4px; font-size: 0.95em; color: #b28900; font-style: italic; line-height: 1.3;}
        .item-actions { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-top: 7px;}
        .btn { padding: 8px 16px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s ease;}
        .btn-ready { background: #f7971e; color: white;}
        .btn-ready:hover { background: #b28900; }
        .last-update { text-align: center; color: #666; font-size: 0.95em; margin-top: 15px;}
        .empty-state { text-align: center; padding: 60px 20px; color: #999;}
        .empty-state .icon { font-size: 4em; margin-bottom: 20px; display: block;}
        @media (max-width: 700px) { .orders-grid { grid-template-columns: 1fr; } .container { padding: 10px; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üç∫ Bar</h1>
        <div class="nav-links">
            <a href="index.html" class="nav-link" id="nav-obsluha">üè† Objedn√°vky</a>
            <a href="kitchen.html" class="nav-link" id="nav-kuchyn">üë®‚Äçüç≥ Kuchy≈à</a>
            <a href="bar.html" class="nav-link active" id="nav-bar">üç∫ Bar</a>
            <a href="serving.html" class="nav-link" id="nav-servirovani">üçΩÔ∏è Serv√≠rov√°n√≠</a>
            <a href="billing.html" class="nav-link" id="nav-uctovani">üí∞ √öƒçtov√°n√≠</a>
            
        </div>
    </div>
    <div class="container">
        <div class="section-title">Objedn√°vky n√°poj≈Ø k p≈ô√≠pravƒõ</div>
        <div class="orders-grid" id="ordersContainer"></div>
        <div class="last-update">Posledn√≠ aktualizace: <span id="lastUpdate">-</span></div>
    </div>
    <script>
    const API = 'api/restaurant-api.php';
    let items = [];
    function loadOrders() {
        fetch(API + '?action=bar-items')
            .then(r=>r.json())
            .then(res => {
                items = res.success ? res.data.items : [];
                renderOrders();
                updateLastUpdateTime();
            });
    }
    function markReady(id, name, btn) {
    if (btn) { 
        btn.disabled = true; 
        btn.textContent = 'Oznaƒçuji...'; 
    }
    
    fetch(API + '?action=item-status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            item_id: id, 
            status: 'ready'
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Okam≈æitƒõ odebereme polo≈æku z DOM
            const itemElement = btn.closest('.order-item');
            if (itemElement) {
                itemElement.remove();
            }
        } else {
            console.error('Chyba p≈ôi oznaƒçov√°n√≠ polo≈æky jako hotov√©:', result.message);
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Hotovo';
            }
        }
    })
    .catch(error => {
        console.error('Chyba p≈ôi oznaƒçov√°n√≠ polo≈æky jako hotov√©:', error);
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'Hotovo';
        }
    });
}
    function renderOrders() {
    const container = document.getElementById('ordersContainer');
    if (items.length === 0) {
        container.innerHTML = `<div class="empty-state">
            <span class="icon">üçπ</span>
            <h3>≈Ω√°dn√© objedn√°vky</h3>
            <p>Moment√°lnƒõ nejsou ≈æ√°dn√© n√°pojov√© objedn√°vky k p≈ô√≠pravƒõ</p>
        </div>`;
        return;
    }
    
    const grouped = {};
    items.forEach(order => {
        const table = order.table_code || order.table_number || 'Nezn√°m√Ω';
        if (!grouped[table]) grouped[table] = [];
        grouped[table].push(order);
    });

    container.innerHTML = Object.entries(grouped).map(([table, items]) => {
        const oldest = items.reduce((a, b) => a.id < b.id ? a : b);
        
        let minutesAgo = 0;
        if (oldest.created_at) {
            const orderTime = new Date(oldest.created_at);
            const currentTime = new Date();
            minutesAgo = Math.floor((currentTime - orderTime) / (1000 * 60));
        }

        const isUrgent = minutesAgo > 15;
        const itemsHTML = items.map(drink => {
            const name = drink.item_name || drink.name || 'N√°poj';
            const quantity = drink.quantity || 1;
            const note = drink.note || '';
            return `
                <div class="order-item">
                    <div class="item-name">${name}</div>
                    <div class="item-quantity">${quantity}√ó</div>
                    ${note ? `<div class="item-note">${note}</div>` : ''}
                    <div class="item-actions">
                        <button class="btn btn-ready" onclick="markReady(${drink.id}, '${name}', this)">
                            Hotovo
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="order-card${isUrgent ? ' urgent' : ''}">
                <div class="order-header">
                    <div class="table-number">üçΩÔ∏è ${table}${minutesAgo > 20 ? '<span class="priority-badge">PRIORITA</span>' : ''}</div>
                    <div class="order-time">‚è±Ô∏è ${minutesAgo} min</div>
                </div>
                <div class="order-items">${itemsHTML}</div>
            </div>
        `;
    }).join('');
}
    function updateLastUpdateTime() {
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('cs-CZ');
    }
    loadOrders();
    setInterval(loadOrders, 1000);
    </script>
</body>
</html>