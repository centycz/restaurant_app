<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√öƒçtov√°n√≠ - P≈ôehled stol≈Ø</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #ff5858 0%, #f09819 100%); min-height: 100vh; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: white; font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);}
        .nav-links { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;}
        .nav-link { padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 25px; font-weight: 500; transition: all 0.3s ease;}
        .nav-link:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px);}
        .nav-link.active { background: white; color: #ff5858;}
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);}
        .section-title { font-size: 1.6em; color: #ff5858; margin: 25px 0 10px 0; font-weight: bold;}
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 30px;}
        .order-card { border: 3px solid #ff5858; border-radius: 15px; padding: 20px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.07); transition: transform 0.3s ease;}
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee;}
        .table-number { font-size: 1.3em; font-weight: bold; color: #f09819; display: flex; align-items: center; gap: 10px;}
        .order-time { color: #666; font-size: 0.95em;}
        .order-items { margin-bottom: 20px; }
        .bill-list { margin: 0 0 8px 0; padding: 0; list-style: none; }
        .bill-item { border-bottom: 1px solid #ffe4bf; padding: 6px 0; display: flex; justify-content: space-between; align-items: center;}
        .bill-item:last-child { border-bottom: none;}
        .bill-name {font-weight: bold;}
        .bill-qty {color: #999;}
        .bill-note {font-size: 0.93em; color: #b67100; font-style: italic;}
        .bill-status { font-size: 0.9em; border-radius: 5px; padding: 2px 8px; margin-left: 7px; color: #fff; background: #ff5858;}
        .bill-item.waiting { background: #ffeaea; }
        .bill-item.doruceno { background: #e0ffe5; }
        .bill-item.zaplaceno { background: #157347; color: #fff;}
        .bill-status.doruceno { background: #27ae60; color: #fff;}
        .bill-status.waiting { background: #ff5858; color: #fff;}
        .bill-status.zaplaceno { background: #0e472e; color: #fff;}
        .bill-total { font-weight: bold; color: #ff5858; font-size: 1.1em; text-align:right; margin-top: 7px;}
        .paid-info { color: #198754; font-size: 0.93em; margin-left: 8px;}
        .btn { padding: 8px 16px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s ease;}
        .btn-pay { background: #ff5858; color: white; margin-top: 9px;}
        .btn-pay:hover { background: #f09819; }
        .btn-split { background: #f09819; color: #fff; margin-top: 9px; margin-left: 7px;}
        .btn-split:hover { background: #ff5858; }
        .last-update { text-align: center; color: #666; font-size: 0.95em; margin-top: 15px;}
        .empty-state { text-align: center; padding: 40px 20px; color: #999;}
        .empty-state .icon { font-size: 4em; margin-bottom: 20px; display: block;}
        
        /* GLOB√ÅLN√ç MODAL BACKGROUND - JEDNOTN√ù PRO V≈†ECHNY MODALY */
        .modal-bg { 
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 100vw; 
            height: 100vh; 
            background: rgba(0,0,0,0.6); 
            display: none;
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
        }
        
        /* SPOLEƒåN√ù STYL PRO V≈†ECHNY MODALY */
        .modal, .confirm-modal { 
            min-width: 600px;
            max-width: 90vw;
            max-height: 90vh;
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3); 
            padding: 40px 50px; 
            position: relative;
            overflow-y: auto;
            margin: 20px;
        }
        
        /* SPOLEƒåN√ù STYL PRO NADPISY V≈†ECH MODAL≈Æ */
        .modal h3, .confirm-modal h3 {
            color: #ff5858; 
            margin-bottom: 30px; 
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
        }
        
        /* Styly pro seznam polo≈æek v rozdƒõlovac√≠m modalu */
        .modal-list {
            list-style: none; 
            padding: 0; 
            margin: 0 0 25px 0;
        }
        
        .modal-item {
            margin-bottom: 18px; 
            font-size: 1.1em;
        }
        
        /* Styl pro celkovou ƒç√°stku */
        .modal-total {
            margin-top: 20px; 
            font-weight: bold; 
            font-size: 1.4em; 
            text-align: center; 
            color: #ff5858;
        }
        
        /* Styly pro tlaƒç√≠tka + a - */
        .quantity-buttons {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-button {
            background-color: #ddd;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            min-width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-button:hover {
            background-color: #bbb;
        }
        
        /* SPOLEƒåN√ù STYL PRO SEKCE V√ùBƒöRU PLATBY */
        .modal-payment-section, .payment-method-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .modal-payment-label, .payment-method-label {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-payment-options, .payment-options {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 25px 0;
        }

        .modal-payment-option, .payment-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 15px;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .modal-payment-option:hover, .payment-option:hover {
            border-color: #ff5858;
            background-color: #fff8f8;
        }

        .modal-payment-option.selected, .payment-option.selected {
            border-color: #ff5858;
            background-color: #fff0f0;
        }

        .modal-payment-option input[type="radio"], .payment-option input[type="radio"] {
            display: none;
        }

        .modal-payment-icon, .payment-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .modal-payment-text, .payment-text {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        /* SPOLEƒåN√ù STYL PRO TLAƒå√çTKA V≈†ECH MODAL≈Æ */
        .modal-btns, .confirm-modal-btns {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 40px;
        }

        .modal-btn, .confirm-modal-btn {
            padding: 18px 40px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        /* Zelen√© tlaƒç√≠tko pro zaplacen√≠ */
        .modal-btn:not(.cancel), .confirm-modal-btn.ok {
            background-color: #28a745;
            color: white;
        }

        .modal-btn:not(.cancel):hover, .confirm-modal-btn.ok:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        /* ƒåerven√© tlaƒç√≠tko pro zru≈°en√≠ */
        .modal-btn.cancel, .confirm-modal-btn.cancel {
            background-color: #dc3545;
            color: white;
        }

        .modal-btn.cancel:hover, .confirm-modal-btn.cancel:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        /* Style pro informaci o platbƒõ */
        .previous-payment-info {
            font-size: 0.9em;
            color: #777;
            margin-top: 5px;
        }

        /* Responsive design pro men≈°√≠ obrazovky */
        @media (max-width: 768px) {
            .modal, .confirm-modal {
                min-width: 95vw;
                padding: 30px 20px;
                margin: 10px;
            }
            
            .modal-btn, .confirm-modal-btn {
                padding: 15px 25px;
                font-size: 1.1em;
                min-width: 140px;
            }
            
            .modal-payment-options, .payment-options {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            
            .modal-payment-option, .payment-option {
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ √öƒçtov√°n√≠</h1>
        <div class="nav-links">
            <a href="index.html" class="nav-link" id="nav-obsluha">üè† Objedn√°vky</a>
            <a href="kitchen.html" class="nav-link" id="nav-kuchyn">üë®‚Äçüç≥ Kuchy≈à</a>
            <a href="bar.html" class="nav-link" id="nav-bar">üç∫ Bar</a>
            <a href="serving.html" class="nav-link" id="nav-servirovani">üçΩÔ∏è Serv√≠rov√°n√≠</a>
            <a href="billing.html" class="nav-link active" id="nav-uctovani">üí∞ √öƒçtov√°n√≠</a>
        </div>
    </div>
    <div class="container">
        <div class="section-title">Aktu√°ln√≠ obsazen√© stoly s objedn√°vkami</div>
        <div class="orders-grid" id="ordersContainer"></div>
        <div class="last-update">Posledn√≠ aktualizace: <span id="lastUpdate">-</span></div>
    </div>

    <!-- Glob√°ln√≠ kontejner pro V≈†ECHNY modaly -->
    <div id="modal-bg" class="modal-bg" style="display:none"></div>

    <script>
    const API = 'api/restaurant-api.php';
    let tables = [];
    let lastSplitTable = null, lastSplitGroups = [];
    let currentTableToPay = null;

    // Seskupen√≠ podle n√°zvu, ceny, pozn√°mky a statusu!
    function groupBillItems(items) {
        let groups = {};
        for (let i of items) {
            let groupKey = i.item_name + "|" + i.unit_price + "|" + (i.note||'') + "|" + i.status;
            if (!groups[groupKey]) {
                groups[groupKey] = {
                    item_name: i.item_name,
                    unit_price: Number(i.unit_price),
                    note: i.note,
                    status: i.status,
                    qty: 0,
                    ids: [],
                };
            }
            groups[groupKey].qty += Number(i.quantity);
            groups[groupKey].ids.push(i.id);
        }
        return Object.values(groups);
    }

    async function loadTables() {
        const tRes = await fetch(API + '?action=tables');
        let allTables = [];
        try { 
            const res = await tRes.json();
            allTables = res.data && res.data.tables ? res.data.tables : []; 
        } catch(e){}
        allTables = allTables.filter(t => t.status === 'occupied');

        let filtered = [];
        for (const t of allTables) {
            const billRes = await fetch(API + '?action=session-bill&table_number=' + t.table_number);
            let items = [];
            try { 
                const bill = await billRes.json();
                items = bill.data && bill.data.items ? bill.data.items : []; 
            } catch(e){}
            // Spoƒç√≠t√°me zaplacenou ƒç√°stku a zb√Ωvaj√≠c√≠ ƒç√°stku
            let paidAmount = 0;
            let totalAmount = 0;
            items.forEach(item => {
                totalAmount += item.unit_price * item.quantity;
                if (item.status === 'paid') {
                    paidAmount += item.unit_price * item.quantity;
                }
            });

            t.paidAmount = paidAmount;
            t.remainingAmount = totalAmount - paidAmount;

            if (items.length) filtered.push({...t, billItems: groupBillItems(items)});
        }
        tables = filtered;
        renderTables();
        updateLastUpdateTime();
    }

    function statusLabel(status) {
        if(status === 'delivered') return {text:'Doruƒçeno', css:'doruceno'};
        if(status === 'paid') return {text:'ZAPLACENO', css:'zaplaceno'};
        return {text:'Doruƒçov√°na', css:'waiting'};
    }

   function renderTables() {
    const container = document.getElementById('ordersContainer');
    if (tables.length === 0) {
        container.innerHTML = `<div class="empty-state">
            <span class="icon">üçΩÔ∏è</span>
            <h3>≈Ω√°dn√Ω obsazen√Ω st≈Øl s √∫ƒçtem</h3>
            <p>Moment√°lnƒõ nen√≠ co √∫ƒçtovat</p>
        </div>`;
        return;
    }
    container.innerHTML = tables.map(t => {
        const items = t.billItems || [];
        const total = items.reduce((s,x)=>s+(x.qty*x.unit_price),0);
        const unpaid = items.filter(i => i.status !== 'paid');
        const allPaid = unpaid.length === 0;
        
        // Kontrola, zda jsou v≈°echny polo≈æky doruƒçen√©
        const allDelivered = items.every(i => i.status === 'delivered' || i.status === 'paid');
        const canPayAll = allDelivered && !allPaid;
        const canPaySplit = !allPaid;

        return `
        <div class="order-card${allPaid ? ' bill-item zaplaceno' : ''}">
            <div class="order-header">
                <div class="table-number">${t.table_code}</div>
                <div class="order-time">${t.status === 'occupied' ? 'Obsazeno' : t.status}</div>
            </div>
            <div class="order-items">
                <ul class="bill-list">
                ${items.map(i=>{
                    const stav = statusLabel(i.status);
                    return `
                    <li class="bill-item ${i.status === 'paid' ? 'zaplaceno' : (i.status === 'delivered' ? 'doruceno' : 'waiting')}">
                        <span>
                            <span class="bill-name">${i.item_name}</span>
                            ${i.qty > 1 ? `<span class="bill-qty">(${i.qty}√ó)</span>` : ""}
                            ${i.note ? `<span class="bill-note">üìù ${i.note}</span>` : ""}
                            <span class="bill-status ${stav.css}">${stav.text}</span>
                        </span>
                        <span>${i.qty * i.unit_price} Kƒç</span>
                    </li>
                    `;
                }).join('')}
                </ul>
                <div class="bill-total">Celkem: ${total} Kƒç</div>
                ${allPaid 
                ? `<div style="font-size:1.16em;font-weight:bold;background:#198754;color:#fff;border-radius:8px;padding:7px 0;text-align:center;margin-top:14px;">ZAPLACENO</div>`
                : `<button class="btn btn-pay" onclick="showConfirmModal(${t.table_number})" ${!canPayAll ? 'disabled' : ''} style="${!canPayAll ? 'opacity:0.5;' : ''}">
                     ${!canPayAll ? 'ƒåEK√Å SE NA DORUƒåEN√ç' : 'ZAPLATIT V≈†E'}
                   </button>
                   <button class="btn btn-split" onclick="paySplit(${t.table_number}, this)" ${canPaySplit ? '' : 'disabled'} style="${canPaySplit ? '' : 'opacity:0.5;'}">
                     ROZDƒöLIT √öƒåET
                   </button>`}
            </div>
            ${t.paidAmount > 0 ? `
            <div class="previous-payment-info">
                Uhrazeno: ${t.paidAmount} Kƒç<br>
                Zb√Ωv√°: ${t.remainingAmount} Kƒç
            </div>
            ` : ''}
        </div>
        `;
    }).join('');
}

// MODAL PRO ZAPLACEN√ç CEL√â OBJEDN√ÅVKY
async function showConfirmModal(table_number) {
    currentTableToPay = table_number;
    const modalBg = document.getElementById('modal-bg');
    modalBg.style.display = 'flex';

    console.log('=== DEBUG: showConfirmModal called for table', table_number, '===');

    // Zobrazit naƒç√≠tac√≠ modal
    modalBg.innerHTML = `
        <div class="confirm-modal">
            <h3>Naƒç√≠t√°m √∫daje...</h3>
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 2em;">‚è≥</div>
                <p>Pros√≠m ƒçekejte...</p>
            </div>
        </div>
    `;

    try {
        // Naƒç√≠st billing data pro st≈Øl
        const billRes = await fetch(API + '?action=session-bill&table_number=' + table_number);
        const billData = await billRes.json();
        const items = billData.data && billData.data.items ? billData.data.items : [];
        
        console.log('DEBUG: Naƒçten√© polo≈æky pro st≈Øl', table_number, ':', items);

        // Filtrovat pouze doruƒçen√© nezaplacen√© polo≈æky
        const deliveredUnpaid = items.filter(i => i.status === 'delivered');
        console.log('DEBUG: Doruƒçen√© nezaplacen√© polo≈æky:', deliveredUnpaid);

        // Vypoƒç√≠tat celkovou ƒç√°stku
        let totalAmount = 0;
        deliveredUnpaid.forEach(item => {
            const itemTotal = item.unit_price * item.quantity;
            totalAmount += itemTotal;
            console.log(`DEBUG: Polo≈æka ${item.item_name} - ${item.quantity}x ${item.unit_price} = ${itemTotal} Kƒç`);
        });
        
        console.log('DEBUG: Celkov√° ƒç√°stka k √∫hradƒõ:', totalAmount, 'Kƒç');

        // Zkontrolovat, zda jsou v≈°echny polo≈æky doruƒçen√©
        const allDelivered = items.every(i => i.status === 'delivered' || i.status === 'paid');
        const hasUnpaidDelivered = deliveredUnpaid.length > 0;
        
        console.log('DEBUG: V≈°echny polo≈æky doruƒçen√©:', allDelivered);
        console.log('DEBUG: M√° nezaplacen√© doruƒçen√© polo≈æky:', hasUnpaidDelivered);

        if (!hasUnpaidDelivered) {
            modalBg.innerHTML = `
                <div class="confirm-modal">
                    <h3>≈Ω√°dn√© polo≈æky k zaplacen√≠</h3>
                    <p style="text-align: center; padding: 20px; font-size: 1.2em;">
                        V≈°echny polo≈æky jsou ji≈æ zaplacen√© nebo nejsou je≈°tƒõ doruƒçen√©.
                    </p>
                    <div class="confirm-modal-btns">
                        <button class="confirm-modal-btn cancel" onclick="closeModal()">ZPƒöT</button>
                    </div>
                </div>
            `;
            return;
        }

        // Zobrazit spr√°vn√Ω modal s celkovou ƒç√°stkou
        modalBg.innerHTML = `
            <div class="confirm-modal">
                <h3>Zaplatit celou objedn√°vku?</h3>
                
                <div class="modal-total" style="font-size: 1.5em; font-weight: bold; color: #ff5858; text-align: center; margin: 20px 0; padding: 15px; background: #fff0f0; border-radius: 10px;">
                    Celkem k √∫hradƒõ: ${totalAmount.toFixed(0)} Kƒç
                </div>
                
                <div class="payment-method-section">
                    <div class="payment-method-label">Vyberte zp≈Øsob platby:</div>
                    <div class="payment-options">
                        <label class="payment-option selected" for="payment-cash">
                            <input type="radio" id="payment-cash" name="payment-method" value="cash" checked>
                            <div class="payment-icon">üíµ</div>
                            <div class="payment-text">Hotovost</div>
                        </label>
                        <label class="payment-option" for="payment-card">
                            <input type="radio" id="payment-card" name="payment-method" value="card">
                            <div class="payment-icon">üí≥</div>
                            <div class="payment-text">Karta</div>
                        </label>
                    </div>
                </div>

                <div class="confirm-modal-btns">
                    <button class="confirm-modal-btn ok" onclick="confirmPayAll()">ZAPLATIT ${totalAmount.toFixed(0)} Kƒç</button>
                    <button class="confirm-modal-btn cancel" onclick="closeModal()">ZPƒöT</button>
                </div>
            </div>
        `;
        
        // Event listenery pro v√Ωbƒõr platby
        setupPaymentOptionListeners('.payment-option');
        
    } catch (error) {
        console.error('DEBUG: Chyba p≈ôi naƒç√≠t√°n√≠ billing dat:', error);
        modalBg.innerHTML = `
            <div class="confirm-modal">
                <h3>Chyba p≈ôi naƒç√≠t√°n√≠</h3>
                <p style="text-align: center; padding: 20px; color: #dc3545;">
                    Nepoda≈ôilo se naƒç√≠st √∫daje o √∫ƒçtu. Zkuste to pros√≠m znovu.
                </p>
                <div class="confirm-modal-btns">
                    <button class="confirm-modal-btn cancel" onclick="closeModal()">ZPƒöT</button>
                </div>
            </div>
        `;
    }
}

// MODAL PRO ROZDƒöLEN√ç √öƒåTU
function showSplitModal(groups) {
    const modalBg = document.getElementById('modal-bg');
    modalBg.style.display = 'flex';

    if (!groups || groups.length === 0) {
        modalBg.innerHTML = `
            <div class="modal">
                <h3>≈Ω√°dn√© polo≈æky k zaplacen√≠</h3>
                <div class="modal-btns">
                    <button class="modal-btn cancel" onclick="closeModal()">ZPƒöT</button>
                </div>
            </div>
        `;
        return;
    }

    modalBg.innerHTML = `
        <div class="modal">
            <h3>Zaplacen√≠ vybran√Ωch polo≈æek</h3>
            <ul class="modal-list">
                ${groups.map((i,idx)=>{
                    if (i.qty === 1) {
                        return `
                        <li class="modal-item">
                            <label>
                                <input type="checkbox" class="split-check" data-groupidx="${idx}" checked>
                                ${i.item_name}
                                (${i.unit_price.toFixed(2)} Kƒç)
                                ${i.note ? `<span class="bill-note">üìù ${i.note}</span>` : ""}
                            </label>
                        </li>
                        `;
                    } else {
                        return `
                        <li class="modal-item">
                            <label>
                                ${i.item_name}
                                <div class="quantity-buttons">
                                    <button class="quantity-button" onclick="changeQuantity(${idx}, -1)">-</button>
                                    <input type="number" min="0" max="${i.qty}" value="0" class="split-qty" data-groupidx="${idx}" style="width:50px;margin:0 8px;font-size:1.1em;" oninput="updateModalTotal()">
                                    <button class="quantity-button" onclick="changeQuantity(${idx}, 1)">+</button>
                                </div>
                                √ó (${i.unit_price.toFixed(2)} Kƒç/ks)
                                ${i.note ? `<span class="bill-note">üìù ${i.note}</span>` : ""}
                            </label>
                        </li>
                        `;
                    }
                }).join('')}
            </ul>
            
            <div class="modal-payment-section">
                <div class="modal-payment-label">Vyberte zp≈Øsob platby:</div>
                <div class="modal-payment-options">
                    <label class="modal-payment-option selected" for="split-payment-cash">
                        <input type="radio" id="split-payment-cash" name="split-payment-method" value="cash" checked>
                        <div class="modal-payment-icon">üíµ</div>
                        <div class="modal-payment-text">Hotovost</div>
                    </label>
                    <label class="modal-payment-option" for="split-payment-card">
                        <input type="radio" id="split-payment-card" name="split-payment-method" value="card">
                        <div class="modal-payment-icon">üí≥</div>
                        <div class="modal-payment-text">Karta</div>
                    </label>
                </div>
            </div>
            
            <div class="modal-total" id="modal-total"></div>
            <div class="modal-btns">
                <button class="modal-btn" onclick="confirmSplitPay()">ZAPLATIT VYBRAN√â</button>
                <button class="modal-btn cancel" onclick="closeModal()">ZPƒöT</button>
            </div>
        </div>
    `;

    updateModalTotal();

    // Event listenery pro v√Ωbƒõr platby
    setupPaymentOptionListeners('.modal-payment-option');
    
    // Event listenery pro quantity inputy a checkboxy
    Array.from(document.querySelectorAll('.split-qty')).forEach(input => {
        input.addEventListener('input', updateModalTotal);
    });
    Array.from(document.querySelectorAll('.split-check')).forEach(cb => {
        cb.addEventListener('change', updateModalTotal);
    });
}

// Spoleƒçn√° funkce pro nastaven√≠ event listener≈Ø pro v√Ωbƒõr platby
function setupPaymentOptionListeners(selector) {
    document.querySelectorAll(selector).forEach(option => {
        option.addEventListener('click', function() {
            // Odstran√≠me selected ze v≈°ech mo≈ænost√≠ tohoto typu
            document.querySelectorAll(selector).forEach(opt => opt.classList.remove('selected'));
            // P≈ôid√°me selected k aktu√°ln√≠ mo≈ænosti
            this.classList.add('selected');
            // Oznaƒç√≠me p≈ô√≠slu≈°n√Ω radio button
            this.querySelector('input[type="radio"]').checked = true;
        });
    });
}

// SPOLEƒåN√Å FUNKCE PRO ZAV≈òEN√ç V≈†ECH MODAL≈Æ
function closeModal() {
    const modalBg = document.getElementById('modal-bg');
    modalBg.style.display = 'none';
    modalBg.innerHTML = '';
    currentTableToPay = null;
}

function confirmPayAll() {
    const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
    console.log('=== DEBUG: confirmPayAll called ===');
    console.log('DEBUG: Zp≈Øsob platby:', paymentMethod);
    console.log('DEBUG: Current table to pay:', currentTableToPay);
    payAll(currentTableToPay);
    closeModal();
}

function payAll(table_number, btn) {
    console.log('=== DEBUG: payAll called for table', table_number, '===');
    if (btn) { btn.disabled = true; btn.textContent = 'Zpracov√°v√°m...'; }
    fetch(API + '?action=session-bill&table_number=' + table_number)
    .then(r=>r.json())
    .then(res => {
        console.log('DEBUG: payAll - API response:', res);
        const items = res.data.items || [];
        console.log('DEBUG: payAll - v≈°echny polo≈æky:', items);
        
        const allDelivered = items.every(i => i.status === 'delivered' || i.status === 'paid');
        console.log('DEBUG: payAll - v≈°echny polo≈æky doruƒçen√©:', allDelivered);
        
        if (!allDelivered) {
            console.log('DEBUG: payAll - ne v≈°echny polo≈æky jsou doruƒçen√©, zru≈°uji platbu');
            if (btn) { 
                btn.disabled = true; 
                btn.textContent = 'ƒåEK√Å SE NA DORUƒåEN√ç'; 
            }
            return;
        }

        const payItems = items
            .filter(i => i.status === 'delivered')
            .map(i => ({
                id: i.id,
                quantity: Number(i.quantity)
            }));

        console.log('DEBUG: payAll - polo≈æky k zaplacen√≠:', payItems);

        if (payItems.length === 0) {
            console.log('DEBUG: payAll - ≈æ√°dn√© polo≈æky k zaplacen√≠');
            if (btn) { btn.disabled = false; btn.textContent = 'ZAPLATIT V≈†E'; }
            loadTables();
            return;
        }

        console.log('DEBUG: payAll - odes√≠l√°m payment request');
        fetch(API + '?action=pay-items', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({items: payItems})
        })
        .then(r=>r.json())
        .then(res => {
            console.log('DEBUG: payAll - payment response:', res);
            if (btn) { btn.disabled = false; btn.textContent = 'ZAPLATIT V≈†E'; }
            loadTables();
        })
        .catch(error => {
            console.error('DEBUG: payAll - payment error:', error);
            if (btn) { btn.disabled = false; btn.textContent = 'ZAPLATIT V≈†E'; }
        });
    })
    .catch(error => {
        console.error('DEBUG: payAll - fetch error:', error);
        if (btn) { btn.disabled = false; btn.textContent = 'ZAPLATIT V≈†E'; }
    });
}

function paySplit(table_number, btn) {
    lastSplitTable = table_number;
    fetch(API + '?action=session-bill&table_number=' + table_number)
    .then(r=>r.json())
    .then(res => {
        const items = res.data.items || [];
        const deliveredUnpaid = items.filter(i => i.status === 'delivered' && i.status !== 'paid' && i.status !== 'cancelled');
        lastSplitGroups = groupBillItems(deliveredUnpaid);
        showSplitModal(lastSplitGroups);
    });
}

function updateModalTotal() {
    let sum = 0;
    Array.from(document.querySelectorAll('.split-qty')).forEach((input) => {
        const groupIdx = parseInt(input.dataset.groupidx, 10);
        const val = parseInt(input.value, 10) || 0;
        sum += val * lastSplitGroups[groupIdx].unit_price;
    });
    Array.from(document.querySelectorAll('.split-check')).forEach((cb) => {
        if (cb.checked) {
            const groupIdx = parseInt(cb.dataset.groupidx, 10);
            sum += lastSplitGroups[groupIdx].unit_price;
        }
    });
    document.getElementById('modal-total').textContent = "Celkem k √∫hradƒõ: " + sum + " Kƒç";
}

function confirmSplitPay() {
    const splitPaymentMethod = document.querySelector('input[name="split-payment-method"]:checked').value;
    console.log('Zp≈Øsob platby (rozdƒõlen√≠):', splitPaymentMethod);
    
    const payArr = [];
    Array.from(document.querySelectorAll('.split-qty')).forEach((input) => {
        const groupIdx = parseInt(input.dataset.groupidx, 10);
        let qty = parseInt(input.value, 10) || 0;
        let group = lastSplitGroups[groupIdx];
        let count = 0;
        for (const id of group.ids) {
            if (count < qty) {
                payArr.push({ id: id, quantity: 1 });
                count++;
            }
        }
    });
    Array.from(document.querySelectorAll('.split-check')).forEach((cb) => {
        if (cb.checked) {
            const groupIdx = parseInt(cb.dataset.groupidx, 10);
            let group = lastSplitGroups[groupIdx];
            payArr.push({ id: group.ids[0], quantity: 1 });
        }
    });

    const payFiltered = payArr.filter(x => x.quantity > 0);
    if (payFiltered.length === 0) return;

    fetch(API + '?action=pay-items', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({items: payFiltered})
    })
    .then(r=>r.json())
    .then(res => {
        closeModal();
        loadTables();
    });
}

function changeQuantity(groupIdx, change) {
    const input = document.querySelector(`.split-qty[data-groupidx="${groupIdx}"]`);
    let qty = parseInt(input.value, 10) || 0;
    qty += change;
    if (qty < 0) qty = 0;
    if (qty > lastSplitGroups[groupIdx].qty) qty = lastSplitGroups[groupIdx].qty;
    input.value = qty;
    updateModalTotal();
}

function updateLastUpdateTime() {
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}

loadTables();
setInterval(loadTables, 7000);

// Glob√°ln√≠ funkce
window.closeModal = closeModal;
window.confirmSplitPay = confirmSplitPay;
window.updateModalTotal = updateModalTotal;
window.showConfirmModal = showConfirmModal;
window.confirmPayAll = confirmPayAll;
window.changeQuantity = changeQuantity;
window.paySplit = paySplit;
</script>
</body>
</html>